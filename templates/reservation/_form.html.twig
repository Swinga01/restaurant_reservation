{{ form_start(form, {'attr': {'id': 'reservation-form', 'class': 'needs-validation', 'novalidate': 'novalidate'}}) }}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Form Card -->
            <div class="card shadow-lg">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">
                        <i class="bi bi-calendar-plus me-2"></i>
                        Nouvelle Réservation
                    </h3>
                </div>
                
                <div class="card-body p-4">
                    <!-- Table Capacity Info -->
                    <div class="alert alert-info mb-4">
                        <h6 class="fw-bold mb-2">
                            <i class="bi bi-info-circle me-2"></i>
                            Capacités des tables disponibles:
                        </h6>
                        <div class="row">
                            {% for tableId, capacity in tableCapacities %}
                                <div class="col-md-4 mb-2">
                                    <span class="badge bg-primary me-2">Table {{ tableId }}</span>
                                    <span class="text-muted">{{ capacity }} personnes max</span>
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                    
                    <!-- Error Alert -->
                    <div id="capacity-alert" class="alert alert-danger d-none">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <span id="capacity-error"></span>
                    </div>
                    
                    <div class="row g-4">
                        <!-- Left Column -->
                        <div class="col-md-6">
                            <!-- Date -->
                            <div class="mb-4">
                                {{ form_label(form.dateReservation, 'Date de réservation', {
                                    'label_attr': {'class': 'form-label fw-bold'}
                                }) }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-calendar"></i>
                                    </span>
                                    {{ form_widget(form.dateReservation, {
                                        'attr': {
                                            'class': 'form-control' ~ (form.dateReservation.vars.errors|length ? ' is-invalid' : ''),
                                            'placeholder': 'JJ/MM/AAAA',
                                            'type': 'date',
                                            'min': 'today'|date('Y-m-d')
                                        }
                                    }) }}
                                </div>
                                {% if form.dateReservation.vars.errors|length %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.dateReservation.vars.errors %}
                                            <i class="bi bi-x-circle me-1"></i>{{ error.message }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Time -->
                            <div class="mb-4">
                                {{ form_label(form.heure, 'Heure', {
                                    'label_attr': {'class': 'form-label fw-bold'}
                                }) }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-clock"></i>
                                    </span>
                                    {{ form_widget(form.heure, {
                                        'attr': {
                                            'class': 'form-control' ~ (form.heure.vars.errors|length ? ' is-invalid' : ''),
                                            'placeholder': 'HH:MM',
                                            'type': 'time',
                                            'min': '11:00',
                                            'max': '23:00'
                                        }
                                    }) }}
                                </div>
                                <small class="form-text text-muted">Horaires: 11:00 - 23:00</small>
                                {% if form.heure.vars.errors|length %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.heure.vars.errors %}
                                            <i class="bi bi-x-circle me-1"></i>{{ error.message }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Number of People -->
                            <div class="mb-4">
                                {{ form_label(form.nombrePersonnes, 'Nombre de personnes', {
                                    'label_attr': {'class': 'form-label fw-bold'}
                                }) }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-people"></i>
                                    </span>
                                    {{ form_widget(form.nombrePersonnes, {
                                        'attr': {
                                            'class': 'form-control' ~ (form.nombrePersonnes.vars.errors|length ? ' is-invalid' : ''),
                                            'placeholder': '1 à 20 personnes',
                                            'min': '1',
                                            'max': '20',
                                            'id': 'nombre-personnes'
                                        }
                                    }) }}
                                </div>
                                {% if form.nombrePersonnes.vars.errors|length %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.nombrePersonnes.vars.errors %}
                                            <i class="bi bi-x-circle me-1"></i>{{ error.message }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Right Column -->
                        <div class="col-md-6">
                            <!-- Table Selection -->
                            <div class="mb-4">
                                {{ form_label(form.tableResto, 'Table', {
                                    'label_attr': {'class': 'form-label fw-bold'}
                                }) }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-table"></i>
                                    </span>
                                    {{ form_widget(form.tableResto, {
                                        'attr': {
                                            'class': 'form-select' ~ (form.tableResto.vars.errors|length ? ' is-invalid' : ''),
                                            'id': 'table-select'
                                        }
                                    }) }}
                                </div>
                                <div id="capacity-info" class="alert alert-info mt-2 d-none">
                                    <i class="bi bi-info-circle me-2"></i>
                                    <span id="capacity-text"></span>
                                </div>
                                {% if form.tableResto.vars.errors|length %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.tableResto.vars.errors %}
                                            <i class="bi bi-x-circle me-1"></i>{{ error.message }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Comment -->
                            <div class="mb-4">
                                {{ form_label(form.commentaire, 'Commentaire (optionnel)', {
                                    'label_attr': {'class': 'form-label fw-bold'}
                                }) }}
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-chat-left"></i>
                                    </span>
                                    {{ form_widget(form.commentaire, {
                                        'attr': {
                                            'class': 'form-control',
                                            'rows': '4',
                                            'placeholder': 'Allergies, célébration, demande spéciale...',
                                            'maxlength': '255'
                                        }
                                    }) }}
                                </div>
                                <small class="form-text text-muted">Maximum 255 caractères</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Validation Rules -->
                    <div class="alert alert-warning mt-4">
                        <h6 class="fw-bold mb-2">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Règles importantes:
                        </h6>
                        <ul class="mb-0">
                            <li>Le nombre de personnes ne peut pas dépasser la capacité de la table</li>
                            <li>Les réservations doivent être faites au moins 2 heures à l'avance</li>
                            <li>Annulation gratuite jusqu'à 24h avant la réservation</li>
                        </ul>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="row mt-5">
                        <div class="col-12">
                            <div class="d-grid gap-3 d-md-flex justify-content-center">
                                <button type="submit" class="btn btn-success btn-lg px-5 py-3" id="submit-btn">
                                    <i class="bi bi-check-circle me-2"></i>
                                    {{ button_label|default('Confirmer la réservation') }}
                                </button>
                                
                                <a href="{{ path('app_reservation_index') }}" class="btn btn-outline-secondary btn-lg px-5 py-3">
                                    <i class="bi bi-arrow-left me-2"></i>
                                    Retour à la liste
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{{ form_end(form) }}

<!-- JavaScript for real-time validation -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const tableSelect = document.getElementById('table-select');
    const peopleInput = document.getElementById('nombre-personnes');
    const capacityInfo = document.getElementById('capacity-info');
    const capacityText = document.getElementById('capacity-text');
    const capacityAlert = document.getElementById('capacity-alert');
    const capacityError = document.getElementById('capacity-error');
    const submitBtn = document.getElementById('submit-btn');
    const form = document.getElementById('reservation-form');
    
    // Debug: Check if elements exist
    console.log('Elements found:', {
        tableSelect: !!tableSelect,
        peopleInput: !!peopleInput,
        capacityInfo: !!capacityInfo,
        capacityAlert: !!capacityAlert,
        submitBtn: !!submitBtn,
        form: !!form
    });
    
    // Store table capacities from controller
    const tableCapacities = {{ tableCapacities|json_encode|raw }};
    console.log('Table capacities:', tableCapacities);
    
    // Function to check capacity
    function checkCapacity() {
        const tableId = tableSelect.value;
        const people = parseInt(peopleInput.value) || 0;
        const capacity = tableCapacities[tableId];
        
        console.log('Checking capacity:', { tableId, people, capacity }); // Debug log
        
        if (tableId && capacity) {
            capacityInfo.classList.remove('d-none');
            capacityAlert.classList.add('d-none');
            
            if (people > capacity) {
                // Show error
                capacityInfo.classList.remove('alert-info');
                capacityInfo.classList.add('alert-danger');
                capacityText.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i> <strong>Dépassement de capacité!</strong> ${people} personne(s) > ${capacity} maximum`;
                
                capacityAlert.classList.remove('d-none');
                capacityError.textContent = `⚠️ ATTENTION: La table sélectionnée a une capacité de ${capacity} personne(s), mais vous avez indiqué ${people} personne(s). Veuillez choisir une table plus grande ou réduire le nombre de personnes.`;
                
                // Add shake animation to submit button
                submitBtn.classList.add('btn-danger');
                submitBtn.classList.remove('btn-success');
                submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i> Corriger la réservation';
                
                submitBtn.disabled = true;
                submitBtn.classList.add('disabled');
                console.log('Capacity exceeded - form disabled'); // Debug log
                return false;
            } else {
                // Show success
                capacityInfo.classList.remove('alert-danger');
                capacityInfo.classList.add('alert-info');
                capacityText.innerHTML = `<i class="bi bi-check-circle me-1"></i> Capacité: ${capacity} personne(s) - OK pour ${people} personne(s)`;
                
                // Restore button appearance
                submitBtn.classList.remove('btn-danger');
                submitBtn.classList.add('btn-success');
                submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i> Confirmer la réservation';
                
                submitBtn.disabled = false;
                submitBtn.classList.remove('disabled');
                console.log('Capacity OK - form enabled'); // Debug log
                return true;
            }
        } else {
            capacityInfo.classList.add('d-none');
            
            // Restore button appearance
            submitBtn.classList.remove('btn-danger');
            submitBtn.classList.add('btn-success');
            submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i> Confirmer la réservation';
            
            submitBtn.disabled = false;
            submitBtn.classList.remove('disabled');
            console.log('No table selected - form enabled'); // Debug log
            return true;
        }
    }
    
    // Event listeners
    if (tableSelect) {
        tableSelect.addEventListener('change', function() {
            console.log('Table selection changed');
            checkCapacity();
        });
    }
    
    if (peopleInput) {
        peopleInput.addEventListener('input', function() {
            console.log('People input changed');
            checkCapacity();
        });
        peopleInput.addEventListener('change', function() {
            console.log('People input changed (change event)');
            checkCapacity();
        });
    }
    
    // Initialize check
    console.log('Initializing capacity check');
    checkCapacity();
});
</script>

<style>
    .is-invalid {
        border-color: #dc3545;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right calc(0.375em + 0.1875rem) center;
        background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    
    .btn.disabled {
        opacity: 0.65;
        cursor: not-allowed;
    }
    
    .alert {
        border-radius: 10px;
        border: none;
    }
    
    .input-group-text {
        background-color: #f8f9fa;
        border-right: none;
    }
</style>
